@model List<StudentEmploymentPortal.Areas.jobpostA.Models.JobPost>
@using StudentEmploymentPortal.Areas.Identity
@using Microsoft.AspNetCore.Identity

@{
    ViewData["Title"] = "Manage Job Posts";
}

<h1 class="mb-4 mt-3">Manage Job Posts</h1>

<form method="post" action="">
    <div class="input-group mb-3">
        <label class="sr-only" for="filterSelect">Filter By:</label>
        <div class="input-group-prepend">
            <span class="input-group-text">Filter By:</span>
        </div>
        <select class="form-control" id="filterSelect">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="queried">Queried</option>
            <option value="approved">Approved</option>
            <option value="withdrawn">Withdrawn</option>
        </select>
    </div>
</form>

@if (Model != null && Model.Count > 0)
{
    <div class="table-responsive">
        <table class="table table-hover table-default">
            <thead>
                <tr class="table-primary">
                    <th>Job title</th>
                    <th>Department</th>
                    <th>FT/PT</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var jobPost in Model)
                {
                    <tr class="job-post-row" data-jobid="@jobPost.JobPostId">
                        <td>@jobPost.JobTitle</td>
                        <td>@jobPost.Department</td>
                        <td>@jobPost.JobType</td>
                        <td>@jobPost.StartDate.ToString("MM/dd/yyyy")</td>
                        <td>@jobPost.EndDate.ToString("MM/dd/yyyy")</td>
                        @if (jobPost.ApprovalStatus.ToString() == "Withdrawn")
                        {
                            <td class="text-danger">@jobPost.ApprovalStatus</td>
                        }
                        else if (jobPost.ApprovalStatus.ToString() == "Approved")
                        {
                            <td class="text-success">@jobPost.ApprovalStatus</td>
                        }
                        else
                        {
                            <td>@jobPost.ApprovalStatus</td>
                        }
                        
                    </tr>
                    @if (jobPost.ApprovalStatus.ToString() != "Withdrawn")
                    {
                        <tr class="job-post-actions-row d-none">
                         <td colspan="6">
                                @if (jobPost.ApprovalStatus.ToString() == "Approved")
                                {
                                    <span class="btn btn-primary btn-sm disabled">Edit Job Post</span>
                                }
                                else
                                {
                                    <a class="btn btn-primary btn-sm" href="@Url.Action("EditJobPost", "JobPost", new { area = "jobpostA", jobPostId = jobPost.JobPostId })">Edit Job Post</a>
                                }
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary btn-sm withdraw-job-post-btn" data-bs-toggle="modal" data-bs-target="#withdrawJobPostModal" data-jobpostid="@jobPost.JobPostId">Withdraw</button>
                                    <a class="btn btn-success btn-sm view-applications-btn" href="@Url.Action("ReviewStudentApplications", "Recruiter", new { area = "RecruiterJ", jobPostId = jobPost.JobPostId })">View Applications</a>
                                </div>
                            
                        </td>
                    </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p>You currently don't have any job posts.</p>
}

<!-- Withdraw Job Post Modal -->
<div class="modal" id="withdrawJobPostModal" tabindex="-1" aria-labelledby="withdrawJobPostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawJobPostModalLabel">Withdraw Job Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to withdraw this job post?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="withdrawJobPostForm" method="post" action="@Url.Action("WithdrawJobPost", "JobPost", new { area = "jobpostA" })">
                    <input type="hidden" name="jobPostId" value="" />
                    <button type="submit" class="btn btn-primary">Withdraw</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .edit-job-post-btn {
        margin-right: 0.5rem;
    }

    .withdraw-job-post-btn {
        margin-right: 0.5rem;

    }
</style>

@section Scripts {
   <script>
    $(document).ready(function () {
        $(".job-post-row").click(function () {
            // Toggle the visibility of job post actions row
            $(this).next(".job-post-actions-row").toggleClass("d-none");
        });

        $(".edit-job-post-btn").click(function (event) {
            event.stopPropagation(); // Prevent row click event from triggering
            var jobId = $(this).closest(".job-post-row").data("jobid");
            // Redirect to the edit job post page using the jobId
            window.location.href = "/JobPost/Edit/" + jobId;
        });

        $(".withdraw-job-post-btn").click(function () {
            var jobPostId = $(this).data("jobpostid");
            // Set the jobPostId value in the hidden form
            $("#withdrawJobPostForm input[name='jobPostId']").val(jobPostId);
        });

        $('#filterSelect').on('change', function () {
            var selectedFilter = $(this).val();
            filterRows(selectedFilter);
        });

        function filterRows(filter) {
            $('tbody tr').each(function () {
                var status = $(this).find('td:nth-child(6)').text();

                if (filter === 'all' || status.toLowerCase() === filter.toLowerCase()) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
    });
</script>

}
